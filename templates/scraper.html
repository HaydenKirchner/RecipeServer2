{% extends "base.html" %}

{% block title %}Recipe Scraper - Recipe Planner{% endblock %}

{% block content %}
<div class="mb-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">Home</a></li>
            <li class="breadcrumb-item active" aria-current="page">Recipe Scraper</li>
        </ol>
    </nav>
</div>

<!-- Debugging Info -->
{% if recipe_data %}
<div class="card mb-4">
    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
        <h3 class="h5 mb-0">Recipe Data Debug</h3>
        <button class="btn btn-sm btn-secondary" id="toggle-debug">Toggle Debug</button>
    </div>
    <div class="card-body" id="debug-content" style="display: none;">
        <pre id="recipe-data-debug">{{ (recipe_payload or {})|tojson(indent=2) }}</pre>
    </div>
</div>
{% endif %}

<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-body">
                <h1 class="card-title h3">Recipe Scraper</h1>
                <p class="card-text">Enter the URL of a recipe you want to import into your collection.</p>
                
                <form id="scraper-form" method="POST" action="/scraper">
                    <div class="input-group mb-3">
                        <input type="url" class="form-control" id="url" name="url" required
                               value="{{ scrape_url or '' }}"
                               placeholder="Enter recipe URL (e.g., https://example.com/recipe)">
                        <button class="btn btn-primary" type="submit" id="scrape-button">
                            <i class="fas fa-search me-1"></i> Scrape Recipe
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% if recipe_data %}
<div class="scraper-preview card shadow-sm mb-4">
    <div class="card-header">
        <h2 class="h4 mb-0">Scraped Recipe Preview</h2>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                {% if recipe_data.image_url %}
                    <img src="{{ recipe_data.image_url }}" alt="{{ recipe_data.title }}" class="img-fluid rounded mb-3">
                {% else %}
                    <div class="text-center p-3 bg-light rounded mb-3">
                        <i class="fas fa-image fa-3x text-secondary mb-2"></i>
                        <p class="text-muted">No image found. Try another URL.</p>
                    </div>
                {% endif %}
            </div>
            <div class="col-md-6">
                <h3 class="h5">{{ recipe_data.title }}</h3>
                
                {% if recipe_data.description %}
                    <p>{{ recipe_data.description }}</p>
                {% endif %}
                
                <div class="d-flex flex-wrap mb-3">
                    {% if recipe_data.prep_time %}
                        <div class="me-3">
                            <i class="fas fa-clock me-1"></i> Prep: {{ recipe_data.prep_time }} min
                        </div>
                    {% endif %}
                    
                    {% if recipe_data.cook_time %}
                        <div class="me-3">
                            <i class="fas fa-fire me-1"></i> Cook: {{ recipe_data.cook_time }} min
                        </div>
                    {% endif %}
                    
                    {% if recipe_data.servings %}
                        <div>
                            <i class="fas fa-users me-1"></i> Serves: {{ recipe_data.servings }}
                        </div>
                    {% endif %}
                </div>
                
                {% if recipe_data.nutrition %}
                    <div class="mb-3">
                        <h4 class="h6">Nutrition (per serving)</h4>
                        <div class="d-flex flex-wrap">
                            {% if recipe_data.nutrition.calories %}
                                <span class="badge bg-primary me-1 mb-1">{{ recipe_data.nutrition.calories|round|int }} kcal</span>
                            {% endif %}
                            {% if recipe_data.nutrition.protein %}
                                <span class="badge bg-success me-1 mb-1">{{ recipe_data.nutrition.protein|round|int }}g protein</span>
                            {% endif %}
                            {% if recipe_data.nutrition.carbs %}
                                <span class="badge bg-info me-1 mb-1">{{ recipe_data.nutrition.carbs|round|int }}g carbs</span>
                            {% endif %}
                            {% if recipe_data.nutrition.fat %}
                                <span class="badge bg-warning me-1 mb-1">{{ recipe_data.nutrition.fat|round|int }}g fat</span>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
                
                <div class="mt-3">
                    <a href="{{ recipe_data.source_url }}" target="_blank" class="btn btn-sm btn-outline-secondary">
                        <i class="fas fa-external-link-alt me-1"></i> View Original
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Save Form -->
        <form id="save-recipe-form" action="/scraper/save" method="POST" class="mt-4">
            <input type="hidden" name="source_url" value="{{ recipe_data.source_url }}">
            
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="title" class="form-label">Recipe Title <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="title" name="title" required
                               value="{{ recipe_data.title }}">
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="3">{{ recipe_data.description }}</textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="prep_time" class="form-label">Prep Time (min)</label>
                            <input type="number" class="form-control" id="prep_time" name="prep_time" min="0"
                                   value="{{ recipe_data.prep_time }}">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="cook_time" class="form-label">Cook Time (min)</label>
                            <input type="number" class="form-control" id="cook_time" name="cook_time" min="0"
                                   value="{{ recipe_data.cook_time }}">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="servings" class="form-label">Servings</label>
                            <input type="number" class="form-control" id="servings" name="servings" min="1"
                                   value="{{ recipe_data.servings }}">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="image_url" class="form-label">Image URL <small class="text-muted">(Enter a URL to an image if none was found)</small></label>
                        <div class="input-group">
                            <input type="url" class="form-control" id="image_url" name="image_url"
                                   value="{{ recipe_data.image_url }}" placeholder="https://example.com/recipe-image.jpg">
                            <button class="btn btn-outline-secondary" type="button" id="test-image-btn">
                                <i class="fas fa-eye me-1"></i> Test
                            </button>
                        </div>
                        <div id="image-preview-container" class="mt-2 d-none">
                            <p class="small mb-1">Image Preview:</p>
                            <img id="image-preview" src="" alt="Image preview" class="img-fluid rounded" style="max-height: 150px">
                        </div>
                        <small class="form-text text-muted">
                            You can paste any image URL here, even if the scraper didn't find one. Click "Test" to preview the image.
                        </small>
                    </div>
                    
                    <!-- Ingredients -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label mb-0">Ingredients</label>
                            <button type="button" class="btn btn-sm btn-primary" id="add-ingredient-btn">
                                <i class="fas fa-plus me-1"></i> Add Ingredient
                            </button>
                        </div>
                        <div id="ingredients-container">
                            {% if recipe_data.ingredients %}
                                {% for ingredient in recipe_data.ingredients %}
                                    <div class="row mb-2 ingredient-row">
                                        <div class="col-md-2">
                                            <input type="number" class="form-control" name="ingredient_amount" step="0.01" min="0"
                                                   placeholder="Amount" value="{{ ingredient.amount if ingredient.amount else '' }}">
                                        </div>
                                        <div class="col-md-2">
                                            <input type="text" class="form-control" name="ingredient_unit" 
                                                   placeholder="Unit" value="{{ ingredient.unit if ingredient.unit else '' }}">
                                        </div>
                                        <div class="col-md-7">
                                            <input type="text" class="form-control" name="ingredient_name" required
                                                   placeholder="Ingredient name" value="{{ ingredient.name }}">
                                        </div>
                                        <div class="col-md-1">
                                            <button type="button" class="btn btn-sm btn-outline-danger remove-ingredient-btn w-100">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <div class="alert alert-warning" id="no-ingredients-alert">
                                    No ingredients could be extracted from the recipe. Click "Add Ingredient" to add them manually.
                                </div>
                                <!-- Default empty ingredient row if none were extracted -->
                                <div class="row mb-2 ingredient-row d-none" id="default-ingredient-row">
                                    <div class="col-md-2">
                                        <input type="number" class="form-control" name="ingredient_amount" step="0.01" min="0"
                                               placeholder="Amount">
                                    </div>
                                    <div class="col-md-2">
                                        <input type="text" class="form-control" name="ingredient_unit" 
                                               placeholder="Unit">
                                    </div>
                                    <div class="col-md-7">
                                        <input type="text" class="form-control" name="ingredient_name" required
                                               placeholder="Ingredient name">
                                    </div>
                                    <div class="col-md-1">
                                        <button type="button" class="btn btn-sm btn-outline-danger remove-ingredient-btn w-100">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <!-- Instructions -->
                    <div class="mb-3">
                        <label for="instructions" class="form-label">Instructions</label>
                        <textarea class="form-control" id="instructions" name="instructions" rows="8">{{ recipe_data.instructions }}</textarea>
                    </div>
                    
                    <!-- Nutrition Information -->
                    <div class="card mb-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>Nutrition Information (per serving)</span>
                            <button type="button" class="btn btn-sm btn-danger" id="clear-nutrition-btn">
                                <i class="fas fa-trash me-1"></i> Clear All
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-2">
                                    <label for="calories" class="form-label">Calories (kcal)</label>
                                    <input type="number" class="form-control nutrition-input" id="calories" name="calories" min="0" step="0.1"
                                           value="{{ recipe_data.nutrition.calories if recipe_data.nutrition else '' }}">
                                </div>
                                <div class="col-md-6 mb-2">
                                    <label for="protein" class="form-label">Protein (g)</label>
                                    <input type="number" class="form-control nutrition-input" id="protein" name="protein" min="0" step="0.1"
                                           value="{{ recipe_data.nutrition.protein if recipe_data.nutrition else '' }}">
                                </div>
                                <div class="col-md-6 mb-2">
                                    <label for="carbs" class="form-label">Carbs (g)</label>
                                    <input type="number" class="form-control nutrition-input" id="carbs" name="carbs" min="0" step="0.1"
                                           value="{{ recipe_data.nutrition.carbs if recipe_data.nutrition else '' }}">
                                </div>
                                <div class="col-md-6 mb-2">
                                    <label for="fat" class="form-label">Fat (g)</label>
                                    <input type="number" class="form-control nutrition-input" id="fat" name="fat" min="0" step="0.1"
                                           value="{{ recipe_data.nutrition.fat if recipe_data.nutrition else '' }}">
                                </div>
                                <div class="col-md-4 mb-2">
                                    <label for="sugar" class="form-label">Sugar (g)</label>
                                    <input type="number" class="form-control nutrition-input" id="sugar" name="sugar" min="0" step="0.1"
                                           value="{{ recipe_data.nutrition.sugar if recipe_data.nutrition else '' }}">
                                </div>
                                <div class="col-md-4 mb-2">
                                    <label for="sodium" class="form-label">Sodium (mg)</label>
                                    <input type="number" class="form-control nutrition-input" id="sodium" name="sodium" min="0" step="0.1"
                                           value="{{ recipe_data.nutrition.sodium if recipe_data.nutrition else '' }}">
                                </div>
                                <div class="col-md-4 mb-2">
                                    <label for="fiber" class="form-label">Fiber (g)</label>
                                    <input type="number" class="form-control nutrition-input" id="fiber" name="fiber" min="0" step="0.1"
                                           value="{{ recipe_data.nutrition.fiber if recipe_data.nutrition else '' }}">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save me-1"></i> Save Recipe to Collection
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="window.location.href='/scraper'">
                            <i class="fas fa-times me-1"></i> Cancel
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>
{% endif %}

<div class="row mt-4">
    <div class="col-md-6">
        <div class="card shadow-sm">
            <div class="card-body">
                <h3 class="h5 card-title">Tips for Recipe Scraping</h3>
                <ul class="list-unstyled">
                    <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i> The scraper works best with structured recipe websites.</li>
                    <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i> Always verify the extracted information before saving.</li>
                    <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i> Some fields may need manual adjustment after scraping.</li>
                    <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i> If nutrition data isn't scraped, you can add it manually.</li>
                </ul>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card shadow-sm">
            <div class="card-body">
                <h3 class="h5 card-title">Example Recipes</h3>
                <p>Try these example URLs that work well with our enhanced scraper:</p>
                <div class="list-group mb-3">
                    {% if example_urls %}
                        {% for url in example_urls %}
                            <button type="button" class="list-group-item list-group-item-action example-url-btn" data-url="{{ url }}">
                                <i class="fas fa-external-link-alt me-2"></i> {{ url|truncate(60) }}
                            </button>
                        {% endfor %}
                    {% else %}
                        <button type="button" class="list-group-item list-group-item-action example-url-btn" 
                               data-url="https://www.allrecipes.com/recipe/228122/teriyaki-salmon/">
                            <i class="fas fa-external-link-alt me-2"></i> Teriyaki Salmon (AllRecipes)
                        </button>
                        <button type="button" class="list-group-item list-group-item-action example-url-btn" 
                               data-url="https://www.foodnetwork.com/recipes/food-network-kitchen/baked-pork-chop-3631185">
                            <i class="fas fa-external-link-alt me-2"></i> Baked Pork Chop (Food Network)
                        </button>
                        <button type="button" class="list-group-item list-group-item-action example-url-btn" 
                               data-url="https://www.wholesomeyum.com/recipes/easy-paleo-keto-bread-recipe/">
                            <i class="fas fa-external-link-alt me-2"></i> Keto Bread (Wholesome Yum)
                        </button>
                    {% endif %}
                </div>
                
                <h4 class="h6">Popular Recipe Sites</h4>
                <ul class="list-unstyled">
                    <li class="mb-2"><i class="fas fa-utensils me-2"></i> <a href="https://www.allrecipes.com" target="_blank">AllRecipes</a></li>
                    <li class="mb-2"><i class="fas fa-utensils me-2"></i> <a href="https://www.foodnetwork.com/recipes" target="_blank">Food Network</a></li>
                    <li class="mb-2"><i class="fas fa-utensils me-2"></i> <a href="https://www.wholesomeyum.com/recipes" target="_blank">Wholesome Yum</a></li>
                    <li class="mb-2"><i class="fas fa-utensils me-2"></i> <a href="https://smittenkitchen.com" target="_blank">Smitten Kitchen</a></li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const scraperForm = document.getElementById('scraper-form');
        const scrapeButton = document.getElementById('scrape-button');
        const urlInput = document.getElementById('url');
        
        // Show loading state while scraping
        scraperForm.addEventListener('submit', function() {
            scrapeButton.disabled = true;
            scrapeButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Scraping...';
        });
        
        // Image preview functionality
        const testImageBtn = document.getElementById('test-image-btn');
        const imageUrlInput = document.getElementById('image_url');
        const imagePreview = document.getElementById('image-preview');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        
        if (testImageBtn && imageUrlInput && imagePreview) {
            testImageBtn.addEventListener('click', function() {
                const imageUrl = imageUrlInput.value.trim();
                
                if (imageUrl) {
                    // Show loading state
                    testImageBtn.disabled = true;
                    testImageBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
                    
                    // Test the image
                    const testImage = new Image();
                    testImage.onload = function() {
                        // Image loaded successfully
                        imagePreview.src = imageUrl;
                        imagePreviewContainer.classList.remove('d-none');
                        testImageBtn.disabled = false;
                        testImageBtn.innerHTML = '<i class="fas fa-check me-1"></i> Valid';
                        testImageBtn.classList.remove('btn-outline-secondary');
                        testImageBtn.classList.add('btn-success');
                        
                        // Reset after 3 seconds
                        setTimeout(() => {
                            testImageBtn.innerHTML = '<i class="fas fa-eye me-1"></i> Test';
                            testImageBtn.classList.remove('btn-success');
                            testImageBtn.classList.add('btn-outline-secondary');
                        }, 3000);
                    };
                    
                    testImage.onerror = function() {
                        // Image failed to load
                        imagePreviewContainer.classList.add('d-none');
                        testImageBtn.disabled = false;
                        testImageBtn.innerHTML = '<i class="fas fa-times me-1"></i> Invalid';
                        testImageBtn.classList.remove('btn-outline-secondary');
                        testImageBtn.classList.add('btn-danger');
                        
                        // Reset after 3 seconds
                        setTimeout(() => {
                            testImageBtn.innerHTML = '<i class="fas fa-eye me-1"></i> Test';
                            testImageBtn.classList.remove('btn-danger');
                            testImageBtn.classList.add('btn-outline-secondary');
                        }, 3000);
                    };
                    
                    testImage.src = imageUrl;
                } else {
                    // No URL entered
                    imagePreviewContainer.classList.add('d-none');
                    alert('Please enter an image URL first.');
                }
            });
            
            // Also check on page load if there's already an image URL
            if (imageUrlInput.value.trim()) {
                imagePreview.src = imageUrlInput.value.trim();
                imagePreviewContainer.classList.remove('d-none');
            }
        }
        
        // Example URL buttons functionality
        document.querySelectorAll('.example-url-btn').forEach(button => {
            button.addEventListener('click', function() {
                const url = this.getAttribute('data-url');
                if(url) {
                    // Fill the URL input field
                    urlInput.value = url;
                    // Highlight the button as active
                    document.querySelectorAll('.example-url-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    // Smoothly scroll to the form
                    scraperForm.scrollIntoView({ behavior: 'smooth' });
                    
                    // Focus on the submit button
                    setTimeout(() => {
                        scrapeButton.focus();
                    }, 500);
                }
            });
        });
        
        // Clear nutrition button functionality
        const clearNutritionBtn = document.getElementById('clear-nutrition-btn');
        if (clearNutritionBtn) {
            clearNutritionBtn.addEventListener('click', function() {
                // Get all nutrition input fields and clear them
                document.querySelectorAll('.nutrition-input').forEach(input => {
                    input.value = '';
                });
                
                // Show success message
                const alertElement = document.createElement('div');
                alertElement.className = 'alert alert-success mt-2 mb-0';
                alertElement.innerText = 'Nutrition values have been cleared.';
                
                // Add the alert before the nutrition inputs
                const cardBody = clearNutritionBtn.closest('.card').querySelector('.card-body');
                cardBody.insertBefore(alertElement, cardBody.firstChild);
                
                // Remove the alert after 3 seconds
                setTimeout(() => {
                    alertElement.remove();
                }, 3000);
            });
        }
        
        // Add ingredient row button functionality
        const addIngredientBtn = document.getElementById('add-ingredient-btn');
        if (addIngredientBtn) {
            const ingredientsContainer = document.getElementById('ingredients-container');
            const noIngredientsAlert = document.getElementById('no-ingredients-alert');
            const defaultIngredientRow = document.getElementById('default-ingredient-row');
            
            // Function to add a new ingredient row
            function addIngredientRow() {
                // If this is the first ingredient, hide the alert and show the default row
                if (noIngredientsAlert && noIngredientsAlert.style.display !== 'none') {
                    noIngredientsAlert.style.display = 'none';
                }
                
                // If we have a default row that's hidden, show it instead of creating a new one
                if (defaultIngredientRow && defaultIngredientRow.classList.contains('d-none')) {
                    defaultIngredientRow.classList.remove('d-none');
                    return;
                }
                
                // Otherwise create a new row
                const newRow = document.createElement('div');
                newRow.className = 'row mb-2 ingredient-row';
                newRow.innerHTML = `
                    <div class="col-md-2">
                        <input type="number" class="form-control" name="ingredient_amount" step="0.01" min="0"
                               placeholder="Amount">
                    </div>
                    <div class="col-md-2">
                        <input type="text" class="form-control" name="ingredient_unit" 
                               placeholder="Unit">
                    </div>
                    <div class="col-md-7">
                        <input type="text" class="form-control" name="ingredient_name" required
                               placeholder="Ingredient name">
                    </div>
                    <div class="col-md-1">
                        <button type="button" class="btn btn-sm btn-outline-danger remove-ingredient-btn w-100">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                ingredientsContainer.appendChild(newRow);
                
                // Add event listener to the new remove button
                const removeBtn = newRow.querySelector('.remove-ingredient-btn');
                if (removeBtn) {
                    removeBtn.addEventListener('click', function() {
                        newRow.remove();
                        
                        // If no ingredients are left, show the alert
                        const remainingRows = ingredientsContainer.querySelectorAll('.ingredient-row:not(.d-none)');
                        if (remainingRows.length === 0 && noIngredientsAlert) {
                            noIngredientsAlert.style.display = 'block';
                        }
                    });
                }
                
                // Focus on the ingredient name field
                const nameInput = newRow.querySelector('input[name="ingredient_name"]');
                if (nameInput) {
                    nameInput.focus();
                }
            }
            
            // Add ingredient when clicking the button
            addIngredientBtn.addEventListener('click', addIngredientRow);
            
            // Add event listeners to existing remove buttons
            document.querySelectorAll('.remove-ingredient-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const row = this.closest('.ingredient-row');
                    if (row) {
                        row.remove();
                        
                        // If no ingredients are left, show the alert
                        const remainingRows = ingredientsContainer.querySelectorAll('.ingredient-row:not(.d-none)');
                        if (remainingRows.length === 0 && noIngredientsAlert) {
                            noIngredientsAlert.style.display = 'block';
                        }
                    }
                });
            });
        }
    });
</script>
{% endblock %}
